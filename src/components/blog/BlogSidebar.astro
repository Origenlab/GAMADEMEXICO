---
// =============================================================================
// BlogSidebar - Sidebar profesional para artículos
// Sigue el patrón de ProductSidebar con estilos de subcategory.css
// =============================================================================

import { CATEGORY_LABELS, CATEGORY_SLUGS } from '../../lib/blogHelpers';
import { WHATSAPP_NUMBER } from '../../lib/config';

interface TOCItem {
  id: string;
  text: string;
  level: number;
}

interface Props {
  headings?: TOCItem[];
  tags?: Map<string, number>;
  showCTA?: boolean;
  categorySlug?: string;
  ctaTitulo?: string;
  ctaTexto?: string;
  whatsappNumero?: string;
  telefonoDisplay?: string;
}

const {
  headings = [],
  tags,
  showCTA = true,
  categorySlug,
  ctaTitulo = 'Cotización Rápida',
  ctaTexto = 'Respuesta en menos de 24 horas con precio y disponibilidad.',
  whatsappNumero = WHATSAPP_NUMBER || '5215565298240',
  telefonoDisplay = '55 6529 8240',
} = Astro.props;

const hasContent = headings.length > 0 || (tags && tags.size > 0) || showCTA;

// Categorías para navegación
const categorias = Object.entries(CATEGORY_LABELS).map(([slug, nombre]) => ({
  slug,
  nombre,
  urlSlug: CATEGORY_SLUGS[slug] || slug,
}));

// Filtrar headings h2 y h3
const filteredHeadings = headings.filter(h => h.level === 2 || h.level === 3);
---

{hasContent && (
  <aside class="blog-sidebar">
    {/* TOC Widget */}
    {filteredHeadings.length > 0 && (
      <div class="sidebar-widget">
        <div class="sidebar-widget__header">
          <h3 class="sidebar-widget__title">En este artículo</h3>
        </div>
        <nav class="sidebar-toc" aria-label="Tabla de contenidos">
          <ul class="sidebar-toc__list">
            {filteredHeadings.map((heading) => (
              <li class={`sidebar-toc__item sidebar-toc__item--level-${heading.level}`}>
                <a href={`#${heading.id}`} class="sidebar-toc__link">
                  <span class="sidebar-toc__indicator"></span>
                  <span class="sidebar-toc__text">{heading.text}</span>
                </a>
              </li>
            ))}
          </ul>
        </nav>
      </div>
    )}

    {/* CTA Widget - Highlight */}
    {showCTA && (
      <div class="sidebar-widget sidebar-widget--highlight">
        <div class="sidebar-widget__header">
          <h3 class="sidebar-widget__title">{ctaTitulo}</h3>
        </div>
        <p class="sidebar-widget__text">{ctaTexto}</p>
        <div class="sidebar-widget__actions">
          <a href="#cotizar" class="btn btn--primary btn--sm btn--full">Solicitar Cotización</a>
          <a href={`https://wa.me/${whatsappNumero}`} class="btn btn--outline btn--sm btn--full" target="_blank" rel="noopener">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
            WhatsApp Directo
          </a>
        </div>
        <p class="sidebar-widget__phone">Tel: <a href={`tel:+52${telefonoDisplay.replace(/\s/g, '')}`}>{telefonoDisplay}</a></p>
      </div>
    )}

    {/* Categorías Widget */}
    <div class="sidebar-widget">
      <div class="sidebar-widget__header">
        <h3 class="sidebar-widget__title">Categorías del Blog</h3>
      </div>
      <nav class="sidebar-nav" aria-label="Categorías del blog">
        <ul class="sidebar-nav__list">
          {categorias.map((cat) => (
            <li class="sidebar-nav__item">
              <a
                href={`/blog/${cat.urlSlug}`}
                class={`sidebar-nav__link ${categorySlug === cat.urlSlug ? 'sidebar-nav__link--active' : ''}`}
              >
                <span class="sidebar-nav__indicator"></span>
                <span class="sidebar-nav__text">{cat.nombre}</span>
              </a>
            </li>
          ))}
        </ul>
      </nav>
      <a href="/blog" class="sidebar-widget__back">← Ver todos los artículos</a>
    </div>

    {/* Tags Widget */}
    {tags && tags.size > 0 && (
      <div class="sidebar-widget">
        <div class="sidebar-widget__header">
          <h3 class="sidebar-widget__title">Etiquetas Populares</h3>
        </div>
        <div class="sidebar-tags">
          {[...tags.entries()].slice(0, 12).map(([tag, count]) => (
            <a href={`/blog/tag/${encodeURIComponent(tag)}`} class="sidebar-tags__item">
              {tag}
              <span class="sidebar-tags__count">{count}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    {/* Slot para contenido adicional */}
    <slot />
  </aside>
)}

<style>
  .blog-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    position: sticky;
    top: 2rem;
  }

  /* SIDEBAR WIDGET - Exactamente como ProductSidebar */
  .sidebar-widget {
    background: var(--color-white);
    border-radius: var(--border-radius);
    padding: 1.25rem;
    border: 1px solid var(--color-border);
  }

  .sidebar-widget--highlight {
    background: linear-gradient(135deg, var(--color-secondary) 0%, #1a365d 100%);
    color: white;
    border: none;
  }

  .sidebar-widget--highlight .sidebar-widget__title {
    color: white;
  }

  .sidebar-widget--highlight .sidebar-widget__text {
    color: rgba(255, 255, 255, 0.85);
  }

  .sidebar-widget__header {
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--color-primary);
  }

  .sidebar-widget--highlight .sidebar-widget__header {
    border-bottom-color: rgba(255, 255, 255, 0.3);
  }

  .sidebar-widget__title {
    font-size: 0.9375rem;
    font-weight: 700;
    color: var(--color-secondary);
    margin: 0;
  }

  .sidebar-widget__text {
    font-size: 0.875rem;
    color: var(--color-text-light);
    margin: 0 0 1rem;
    line-height: 1.5;
  }

  .sidebar-widget__actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .sidebar-widget__actions .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .sidebar-widget__actions .btn--outline {
    border-color: rgba(255, 255, 255, 0.5);
    color: white;
  }

  .sidebar-widget__actions .btn--outline:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: white;
  }

  .sidebar-widget__phone {
    font-size: 0.8125rem;
    text-align: center;
    margin: 1rem 0 0;
    color: rgba(255, 255, 255, 0.85);
  }

  .sidebar-widget__phone a {
    color: white;
    font-weight: 600;
    text-decoration: none;
  }

  .sidebar-widget__back {
    display: block;
    text-align: center;
    font-size: 0.8125rem;
    color: var(--color-primary);
    text-decoration: none;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
    margin-top: 0.5rem;
    transition: color 0.2s;
  }

  .sidebar-widget__back:hover {
    color: var(--color-secondary);
  }

  /* SIDEBAR TOC */
  .sidebar-toc__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .sidebar-toc__link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    text-decoration: none;
    color: var(--color-text);
    background: var(--color-accent);
    transition: all 0.2s;
    font-size: 0.8125rem;
    line-height: 1.4;
  }

  .sidebar-toc__link:hover {
    background: var(--color-border);
    color: var(--color-primary);
  }

  .sidebar-toc__item--level-3 .sidebar-toc__link {
    padding-left: 1.5rem;
    font-size: 0.75rem;
    background: transparent;
  }

  .sidebar-toc__item--level-3 .sidebar-toc__link:hover {
    background: var(--color-accent);
  }

  .sidebar-toc__indicator {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--color-border);
    flex-shrink: 0;
  }

  .sidebar-toc__link:hover .sidebar-toc__indicator {
    background: var(--color-primary);
  }

  .sidebar-toc__item--level-3 .sidebar-toc__indicator {
    width: 4px;
    height: 4px;
  }

  /* SIDEBAR NAV */
  .sidebar-nav__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .sidebar-nav__link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    text-decoration: none;
    color: var(--color-text);
    background: var(--color-accent);
    transition: all 0.2s;
    font-size: 0.875rem;
  }

  .sidebar-nav__link:hover {
    background: var(--color-border);
    color: var(--color-primary);
  }

  .sidebar-nav__link--active {
    background: var(--color-primary);
    color: white;
    font-weight: 600;
  }

  .sidebar-nav__indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-border);
    flex-shrink: 0;
  }

  .sidebar-nav__link--active .sidebar-nav__indicator {
    background: white;
  }

  .sidebar-nav__text {
    flex: 1;
  }

  /* SIDEBAR TAGS */
  .sidebar-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .sidebar-tags__item {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    background: var(--color-accent);
    border-radius: 50px;
    font-size: 0.75rem;
    color: var(--color-text);
    text-decoration: none;
    transition: all 0.2s;
  }

  .sidebar-tags__item:hover {
    background: var(--color-primary);
    color: white;
  }

  .sidebar-tags__count {
    background: rgba(0, 0, 0, 0.1);
    padding: 0.125rem 0.375rem;
    border-radius: 50px;
    font-size: 0.625rem;
    font-weight: 600;
  }

  .sidebar-tags__item:hover .sidebar-tags__count {
    background: rgba(255, 255, 255, 0.2);
  }

  @media (max-width: 1024px) {
    .blog-sidebar {
      display: none;
    }
  }
</style>
