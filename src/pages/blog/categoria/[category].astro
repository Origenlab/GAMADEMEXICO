---
// =============================================================================
// Blog Category - Página de categoría
// =============================================================================

import Layout from '../../../layouts/Base.astro';
import { getCollection } from 'astro:content';
import BlogGrid from '../../../components/blog/BlogGrid.astro';
import BlogCategories from '../../../components/blog/BlogCategories.astro';
import { getCategoriesWithCount, CATEGORY_LABELS } from '../../../lib/blogHelpers';
import { buildBreadcrumbSchema } from '../../../lib/seo';

// Metadata de categorías para SEO (coinciden con productos del sitio)
const CATEGORY_META: Record<string, { title: string; description: string }> = {
  monitores: {
    title: 'Monitores Contra Incendios',
    description:
      'Guías técnicas sobre monitores contra incendios: selección, mantenimiento, normatividad NFPA y certificaciones FM/UL. Monitores tipo corazón y cuello de cisne.',
  },
  boquillas: {
    title: 'Boquillas Contra Incendios',
    description:
      'Artículos sobre boquillas contra incendios: tipos (pistola, turbo jet, industrial), selección por GPM, patrones de descarga y certificaciones.',
  },
  mangueras: {
    title: 'Mangueras Contra Incendios',
    description:
      'Guías sobre mangueras contra incendios: tipos (doble forro, Blindex, forestal), selección, cuidado, normativa NFPA 1961 y mantenimiento.',
  },
  valvulas: {
    title: 'Válvulas Contra Incendios',
    description:
      'Todo sobre válvulas para sistemas contra incendios: OS&Y, mariposa, retención, globe. Instalación, mantenimiento y certificaciones UL/FM.',
  },
  'conexiones-herrajes': {
    title: 'Conexiones y Herrajes',
    description:
      'Artículos técnicos sobre conexiones contra incendios: adaptadores, siamesas FDC, coples Storz, Wye, reducciones y herrajes de bronce.',
  },
  'gabinetes-hidrantes': {
    title: 'Gabinetes e Hidrantes',
    description:
      'Guías sobre gabinetes contra incendios e hidrantes: tipos, instalación, normativa NFPA 14, mantenimiento y equipamiento completo.',
  },
};

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);

  // Obtener categorías únicas
  const categories = [...new Set(posts.map((p) => p.data.categoria))];

  return categories.map((category) => ({
    params: { category },
    props: {
      category,
      posts: posts
        .filter((p) => p.data.categoria === category)
        .sort((a, b) => new Date(b.data.fecha).getTime() - new Date(a.data.fecha).getTime()),
    },
  }));
}

const { category, posts } = Astro.props;
const meta = CATEGORY_META[category] || {
  title: CATEGORY_LABELS[category] || category,
  description: `Artículos sobre ${CATEGORY_LABELS[category] || category} en el blog de Gama de México.`,
};
const categoryLabel = CATEGORY_LABELS[category] || category;

// Obtener todas las categorías para navegación
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const categories = getCategoriesWithCount(allPosts);

// Schema breadcrumb
const breadcrumbSchema = buildBreadcrumbSchema([
  { name: 'Inicio', url: '/' },
  { name: 'Blog', url: '/blog' },
  { name: categoryLabel, url: `/blog/categoria/${category}` },
]);
---

<Layout
  title={`${meta.title} | Blog Gama de México`}
  description={meta.description}
  heroTitle={meta.title}
  heroIntro={meta.description}
  heroBadge="Categoría"
  heroPrimaryText="Solicitar Asesoría"
  heroPrimaryLink="#cotizar"
  heroSecondaryText="Ver Todos"
  heroSecondaryLink="/blog"
  structuredData={[breadcrumbSchema]}
>
  <!-- Navegación de categorías -->
  <BlogCategories categories={categories} activeCategory={category} />

  <!-- Grid de artículos -->
  <BlogGrid
    posts={posts}
    titulo={`${posts.length} ${posts.length === 1 ? 'artículo' : 'artículos'} en ${categoryLabel}`}
    columns={3}
  />

  {posts.length === 0 && (
    <section class="blog-empty">
      <div class="container">
        <p>No hay artículos en esta categoría todavía.</p>
        <a href="/blog" class="btn btn--primary">Ver todos los artículos</a>
      </div>
    </section>
  )}
</Layout>

<style>
  .blog-empty {
    padding: var(--spacing-3xl) 0;
    text-align: center;
    background: var(--color-accent);
  }

  .blog-empty p {
    margin-bottom: var(--spacing-lg);
    color: var(--color-text-light);
  }
</style>
