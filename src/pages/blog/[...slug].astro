---
// =============================================================================
// Blog Post - Página de artículo individual
// =============================================================================

import Layout from '../../layouts/Base.astro';
import { getCollection, render } from 'astro:content';
import BlogSidebar from '../../components/blog/BlogSidebar.astro';
import BlogAuthor from '../../components/blog/BlogAuthor.astro';
import BlogRelatedPosts from '../../components/blog/BlogRelatedPosts.astro';
import BlogCTA from '../../components/blog/BlogCTA.astro';
import CotizacionForm from '../../components/CotizacionForm.astro';
import { buildArticleSchema, buildBreadcrumbSchema } from '../../lib/seo';
import {
  formatDateSpanish,
  calculateReadingTime,
  getRelatedPosts,
  getAllTags,
  extractTableOfContents,
  CATEGORY_LABELS,
} from '../../lib/blogHelpers';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

// Obtener posts relacionados
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const relatedPosts = getRelatedPosts(post, allPosts, 3);

// Tags para sidebar
const allTags = getAllTags(allPosts);

// TOC items
const tocItems = extractTableOfContents(headings);

// Calcular tiempo de lectura si no está definido
const readingTime = post.data.tiempoLectura || calculateReadingTime(post.body || '');

// Nombre de categoría
const categoryLabel = CATEGORY_LABELS[post.data.categoria] || post.data.categoria;

// Schema Article
const articleSchema = buildArticleSchema({
  title: post.data.title,
  description: post.data.description,
  url: `/blog/${post.id}`,
  image: post.data.imagen,
  datePublished: post.data.fecha,
  dateModified: post.data.fechaActualizacion,
  author: post.data.autor,
  category: categoryLabel,
  tags: post.data.tags,
  readingTime,
});

// Schema Breadcrumb
const breadcrumbSchema = buildBreadcrumbSchema([
  { name: 'Inicio', url: '/' },
  { name: 'Blog', url: '/blog' },
  { name: categoryLabel, url: `/blog/categoria/${post.data.categoria}` },
  { name: post.data.title, url: `/blog/${post.id}` },
]);
---

<Layout
  title={`${post.data.title} | Blog Gama de México`}
  description={post.data.description}
  ogImage={post.data.imagenOg || post.data.imagen}
  canonical={post.data.canonical}
  heroTitle={post.data.title}
  heroIntro={post.data.description}
  heroBadge={categoryLabel}
  heroPrimaryText="Cotizar Equipos"
  heroPrimaryLink="#cotizar"
  heroSecondaryText="Volver al Blog"
  heroSecondaryLink="/blog"
  structuredData={[articleSchema, breadcrumbSchema]}
>
  <article class="blog-article">
    <div class="container">
      <div class="blog-article__layout">
        <!-- Contenido principal -->
        <div class="blog-article__main">
          <!-- Meta información -->
          <div class="blog-article__meta">
            <time datetime={post.data.fecha}>{formatDateSpanish(post.data.fecha)}</time>
            <span class="blog-article__separator">·</span>
            <span>{readingTime} min lectura</span>
            {post.data.fechaActualizacion && (
              <>
                <span class="blog-article__separator">·</span>
                <span>Actualizado: {formatDateSpanish(post.data.fechaActualizacion)}</span>
              </>
            )}
          </div>

          <!-- Imagen destacada -->
          {post.data.imagen && (
            <figure class="blog-article__hero-image">
              <img
                src={post.data.imagen}
                alt={post.data.imagenAlt || post.data.title}
                loading="eager"
              />
            </figure>
          )}

          <!-- Contenido markdown -->
          <div class="blog-article__content">
            <Content />
          </div>

          <!-- CTA inline -->
          <BlogCTA variant="fullwidth" />

          <!-- Caja del autor -->
          <BlogAuthor autor={post.data.autor} />

          <!-- Tags -->
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="blog-article__tags">
              <span class="blog-article__tags-label">Etiquetas:</span>
              {post.data.tags.map((tag) => (
                <a href={`/blog/tag/${encodeURIComponent(tag)}`} class="blog-article__tag">
                  {tag}
                </a>
              ))}
            </div>
          )}
        </div>

        <!-- Sidebar -->
        <BlogSidebar headings={tocItems} tags={allTags} showCTA={true} />
      </div>
    </div>
  </article>

  <!-- Artículos relacionados -->
  <BlogRelatedPosts
    posts={relatedPosts}
    titulo="Artículos Relacionados"
    subtitulo="Continúa aprendiendo sobre equipos contra incendios"
  />

  <!-- Formulario de cotización -->
  <section id="cotizar" class="blog-cotizar">
    <div class="container">
      <CotizacionForm
        titulo="¿Necesitas Asesoría Técnica?"
        pagina={`Blog: ${post.data.title}`}
      />
    </div>
  </section>
</Layout>

<style>
  .blog-article {
    padding: var(--spacing-3xl) 0;
    background: var(--color-white);
  }

  .blog-article__layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-2xl);
  }

  .blog-article__main {
    max-width: 100%;
  }

  .blog-article__meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--font-size-sm);
    color: var(--color-text-light);
    margin-bottom: var(--spacing-lg);
  }

  .blog-article__separator {
    color: var(--color-border);
  }

  .blog-article__hero-image {
    margin: 0 0 var(--spacing-xl) 0;
    border-radius: var(--border-radius);
    overflow: hidden;
  }

  .blog-article__hero-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Estilos para contenido markdown */
  .blog-article__content {
    max-width: 750px;
  }

  .blog-article__content :global(h2) {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: var(--color-secondary);
    line-height: 1.3;
  }

  .blog-article__content :global(h3) {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: var(--font-size-xl);
    font-weight: 600;
    color: var(--color-secondary);
    line-height: 1.35;
  }

  .blog-article__content :global(h4) {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--color-secondary);
  }

  .blog-article__content :global(p) {
    margin-bottom: var(--spacing-md);
    font-size: var(--font-size-base);
    line-height: 1.8;
    color: var(--color-text);
  }

  .blog-article__content :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
    font-weight: 500;
  }

  .blog-article__content :global(a:hover) {
    color: var(--color-primary-dark);
  }

  .blog-article__content :global(ul),
  .blog-article__content :global(ol) {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-lg);
  }

  .blog-article__content :global(li) {
    margin-bottom: var(--spacing-xs);
    line-height: 1.7;
    color: var(--color-text);
  }

  .blog-article__content :global(strong) {
    font-weight: 600;
    color: var(--color-secondary);
  }

  .blog-article__content :global(blockquote) {
    margin: var(--spacing-xl) 0;
    padding: var(--spacing-md) var(--spacing-lg);
    border-left: 4px solid var(--color-primary);
    background: var(--color-accent);
    font-style: italic;
    color: var(--color-text);
  }

  .blog-article__content :global(blockquote p) {
    margin-bottom: 0;
  }

  .blog-article__content :global(code) {
    background: var(--color-accent);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: 'Consolas', 'Monaco', monospace;
  }

  .blog-article__content :global(pre) {
    background: var(--color-secondary);
    color: var(--color-white);
    padding: var(--spacing-md);
    border-radius: var(--border-radius);
    overflow-x: auto;
    margin: var(--spacing-lg) 0;
  }

  .blog-article__content :global(pre code) {
    background: none;
    padding: 0;
    color: inherit;
  }

  .blog-article__content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--border-radius);
    margin: var(--spacing-lg) 0;
  }

  .blog-article__content :global(hr) {
    border: none;
    border-top: 1px solid var(--color-border);
    margin: var(--spacing-2xl) 0;
  }

  .blog-article__content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: var(--spacing-lg) 0;
  }

  .blog-article__content :global(th),
  .blog-article__content :global(td) {
    padding: var(--spacing-sm);
    border: 1px solid var(--color-border);
    text-align: left;
  }

  .blog-article__content :global(th) {
    background: var(--color-accent);
    font-weight: 600;
    color: var(--color-secondary);
  }

  /* Tags */
  .blog-article__tags {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    margin-top: var(--spacing-xl);
    padding-top: var(--spacing-lg);
    border-top: 1px solid var(--color-border);
  }

  .blog-article__tags-label {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-secondary);
  }

  .blog-article__tag {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 4px;
    font-size: var(--font-size-xs);
    font-weight: 500;
    color: var(--color-text);
    background: var(--color-accent);
    text-decoration: none;
    transition: all var(--transition-fast);
  }

  .blog-article__tag:hover {
    background: var(--color-border);
    color: var(--color-secondary);
  }

  /* Cotización */
  .blog-cotizar {
    padding: var(--spacing-3xl) 0;
    background: var(--color-accent);
  }

  @media (min-width: 1024px) {
    .blog-article__layout {
      grid-template-columns: 1fr 300px;
    }

    .blog-article__content :global(h2) {
      font-size: var(--font-size-3xl);
    }
  }

  @media (min-width: 1280px) {
    .blog-article__layout {
      grid-template-columns: 1fr 320px;
    }
  }
</style>
