---
// =============================================================================
// Blog Index - Listado principal de artículos
// =============================================================================

import Layout from '../../layouts/Base.astro';
import { getCollection } from 'astro:content';
import BlogGrid from '../../components/blog/BlogGrid.astro';
import BlogCategories from '../../components/blog/BlogCategories.astro';
import BlogCard from '../../components/blog/BlogCard.astro';
import { getCategoriesWithCount, getAllTags } from '../../lib/blogHelpers';
import { buildBreadcrumbSchema } from '../../lib/seo';

// Obtener todos los posts publicados
const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => new Date(b.data.fecha).getTime() - new Date(a.data.fecha).getTime());

// Posts destacados (máximo 3)
const featuredPosts = allPosts.filter((p) => p.data.destacado).slice(0, 3);

// Posts regulares (excluyendo destacados para evitar duplicados en featured)
const regularPosts = featuredPosts.length > 0
  ? allPosts.filter((p) => !featuredPosts.some((f) => f.id === p.id))
  : allPosts;

// Obtener categorías con conteo
const categories = getCategoriesWithCount(allPosts);

// Schema breadcrumb
const breadcrumbSchema = buildBreadcrumbSchema([
  { name: 'Inicio', url: '/' },
  { name: 'Blog', url: '/blog' },
]);
---

<Layout
  title="Blog de Equipos Contra Incendios | Gama de México"
  description="Guías técnicas, normatividad NFPA y NOM, y mejores prácticas para sistemas contra incendios en México. Contenido por ingenieros especializados."
  heroTitle="Blog Técnico de Equipos Contra Incendios"
  heroIntro="Artículos profesionales para seleccionar, instalar y mantener equipos contra incendio con enfoque en cumplimiento normativo y seguridad operacional."
  heroBadge="Recursos y Guías"
  heroMetrics={[
    { valor: `${allPosts.length}+`, texto: 'Artículos técnicos' },
    { valor: 'NFPA', texto: 'Normativas cubiertas' },
    { valor: 'NOM', texto: 'Cumplimiento México' },
  ]}
  heroPrimaryText="Solicitar Asesoría"
  heroPrimaryLink="#cotizar"
  heroSecondaryText="Ver Equipos"
  heroSecondaryLink="/equipos"
  heroShowRightContent={true}
  structuredData={[breadcrumbSchema]}
>
  <Fragment slot="hero-content">
    <p>
      En nuestro <strong>blog técnico</strong> encontrarás guías detalladas sobre selección de equipos
      contra incendios, requisitos normativos NFPA y NOM, mejores prácticas de instalación y
      mantenimiento preventivo. Contenido desarrollado por nuestro equipo de ingenieros con más de 30
      años de experiencia en protección contra incendios para industria petrolera, petroquímica y
      manufactura.
    </p>
  </Fragment>

  <!-- Navegación de categorías -->
  <BlogCategories categories={categories} />

  <!-- Artículos destacados -->
  {featuredPosts.length > 0 && (
    <section class="blog-featured" aria-labelledby="featured-title">
      <div class="container">
        <h2 id="featured-title" class="section-title">Artículos Destacados</h2>
        <div class="blog-featured__grid">
          {featuredPosts.map((post) => (
            <BlogCard
              title={post.data.title}
              description={post.data.description}
              slug={post.id}
              fecha={post.data.fecha}
              categoria={post.data.categoria}
              autor={post.data.autor}
              imagen={post.data.imagen}
              imagenAlt={post.data.imagenAlt}
              destacado={true}
              tiempoLectura={post.data.tiempoLectura}
            />
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Todos los artículos -->
  <BlogGrid
    posts={regularPosts}
    titulo="Artículos Recientes"
    subtitulo="Últimas publicaciones de nuestro equipo técnico"
    columns={3}
  />
</Layout>

<style>
  .blog-featured {
    padding: var(--spacing-3xl) 0;
    background: var(--color-white);
  }

  .blog-featured__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
    margin-top: var(--spacing-lg);
  }

  @media (min-width: 768px) {
    .blog-featured__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .blog-featured__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>
