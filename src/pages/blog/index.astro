---
// =============================================================================
// Blog Index - Listado principal de artículos
// Diseño profesional con secciones alternadas
// =============================================================================

import Layout from '../../layouts/Base.astro';
import { getCollection } from 'astro:content';
import BlogGrid from '../../components/blog/BlogGrid.astro';
import BlogCategories from '../../components/blog/BlogCategories.astro';
import BlogCard from '../../components/blog/BlogCard.astro';
import BlogCTA from '../../components/blog/BlogCTA.astro';
import { getCategoriesWithCount, getAllTags, CATEGORY_LABELS, CATEGORY_SLUGS } from '../../lib/blogHelpers';
import { buildBreadcrumbSchema } from '../../lib/seo';

// Obtener todos los posts publicados
const allPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => new Date(b.data.fecha).getTime() - new Date(a.data.fecha).getTime());

// Posts destacados (máximo 3)
const featuredPosts = allPosts.filter((p) => p.data.destacado).slice(0, 3);

// Posts regulares (excluyendo destacados para evitar duplicados en featured)
const regularPosts = featuredPosts.length > 0
  ? allPosts.filter((p) => !featuredPosts.some((f) => f.id === p.id))
  : allPosts;

// Obtener categorías con conteo
const categories = getCategoriesWithCount(allPosts);

// Schema breadcrumb
const breadcrumbSchema = buildBreadcrumbSchema([
  { name: 'Inicio', url: '/' },
  { name: 'Blog', url: '/blog' },
]);
---

<Layout
  title="Blog de Equipos Contra Incendios | Gama de México"
  description="Guías técnicas, normatividad NFPA y NOM, y mejores prácticas para sistemas contra incendios en México. Contenido por ingenieros especializados."
  heroTitle="Blog Técnico de Equipos Contra Incendios"
  heroIntro="Artículos profesionales para seleccionar, instalar y mantener equipos contra incendio con enfoque en cumplimiento normativo y seguridad operacional."
  heroBadge="Recursos y Guías"
  heroMetrics={[
    { valor: `${allPosts.length}+`, texto: 'Artículos técnicos' },
    { valor: 'NFPA', texto: 'Normativas cubiertas' },
    { valor: 'NOM', texto: 'Cumplimiento México' },
  ]}
  heroPrimaryText="Solicitar Asesoría"
  heroPrimaryLink="#cotizar"
  heroSecondaryText="Ver Equipos"
  heroSecondaryLink="/equipos"
  heroShowRightContent={true}
  structuredData={[breadcrumbSchema]}
>
  <Fragment slot="hero-content">
    <p>
      En nuestro <strong>blog técnico</strong> encontrarás guías detalladas sobre selección de equipos
      contra incendios, requisitos normativos NFPA y NOM, mejores prácticas de instalación y
      mantenimiento preventivo. Contenido desarrollado por nuestro equipo de ingenieros con más de 30
      años de experiencia en protección contra incendios para industria petrolera, petroquímica y
      manufactura.
    </p>
  </Fragment>

  <!-- Navegación de categorías -->
  <BlogCategories categories={categories} showHeader={false} />

  <!-- Artículos destacados -->
  {featuredPosts.length > 0 && (
    <section class="blog-featured" aria-labelledby="featured-title">
      <div class="container">
        <div class="catalog-header">
          <div class="catalog-header__info">
            <h2 id="featured-title" class="catalog-header__title">Artículos Destacados</h2>
            <p class="catalog-header__desc">Contenido seleccionado por nuestro equipo técnico</p>
          </div>
          <div class="catalog-header__count">
            <span class="catalog-header__number">{featuredPosts.length}</span>
            <span class="catalog-header__label">Destacados</span>
          </div>
        </div>
        <div class="blog-featured__grid">
          {featuredPosts.map((post) => (
            <BlogCard
              title={post.data.title}
              description={post.data.description}
              slug={post.id}
              fecha={post.data.fecha}
              categoria={post.data.categoria}
              autor={post.data.autor}
              imagen={post.data.imagen}
              imagenAlt={post.data.imagenAlt}
              destacado={true}
              tiempoLectura={post.data.tiempoLectura}
            />
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Todos los artículos -->
  <BlogGrid
    posts={regularPosts}
    titulo="Artículos Recientes"
    subtitulo="Últimas publicaciones de nuestro equipo técnico"
    columns={3}
    background="accent"
    showCount={true}
  />

  <!-- CTA intermedio -->
  <section class="blog-cta-section">
    <div class="container">
      <BlogCTA
        titulo="¿Necesitas equipos contra incendios?"
        texto="Nuestros ingenieros especializados te ayudan a seleccionar el equipo correcto según normatividad NFPA y NOM."
        variant="fullwidth"
      />
    </div>
  </section>

  <!-- Explorar por categoría -->
  <section class="blog-explore">
    <div class="container">
      <div class="catalog-header">
        <div class="catalog-header__info">
          <h2 class="catalog-header__title">Explora por Categoría</h2>
          <p class="catalog-header__desc">Artículos técnicos organizados por tipo de equipo</p>
        </div>
      </div>
      <div class="blog-explore__grid">
        {categories.map((cat) => {
          const urlSlug = CATEGORY_SLUGS[cat.slug] || cat.slug;
          return (
            <a href={`/blog/${urlSlug}`} class="blog-explore__card">
              <div class="blog-explore__card-icon">
                <span class="blog-explore__indicator"></span>
              </div>
              <div class="blog-explore__card-content">
                <h3 class="blog-explore__card-title">{CATEGORY_LABELS[cat.slug] || cat.name}</h3>
                <p class="blog-explore__card-count">{cat.count} {cat.count === 1 ? 'artículo' : 'artículos'}</p>
              </div>
              <span class="blog-explore__arrow">→</span>
            </a>
          );
        })}
      </div>
    </div>
  </section>
</Layout>

<style>
  /* FEATURED SECTION */
  .blog-featured {
    padding: var(--spacing-3xl) 0;
    background: var(--color-white);
  }

  .blog-featured__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-lg);
  }

  /* CATALOG HEADER - Reutilizado */
  .catalog-header {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    padding-bottom: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
    border-bottom: 2px solid var(--color-primary);
  }

  .catalog-header__info {
    flex: 1;
  }

  .catalog-header__title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-secondary);
    margin: 0 0 0.25rem;
  }

  .catalog-header__desc {
    font-size: 0.9375rem;
    color: var(--color-text-light);
    margin: 0;
  }

  .catalog-header__count {
    text-align: center;
  }

  .catalog-header__number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-primary);
    line-height: 1;
  }

  .catalog-header__label {
    font-size: 0.75rem;
    color: var(--color-text-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* CTA SECTION */
  .blog-cta-section {
    padding: var(--spacing-3xl) 0;
    background: var(--color-white);
  }

  /* EXPLORE SECTION */
  .blog-explore {
    padding: var(--spacing-3xl) 0;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  }

  .blog-explore__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-md);
  }

  .blog-explore__card {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    background: var(--color-white);
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    text-decoration: none;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .blog-explore__card:hover {
    border-color: var(--color-primary);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
  }

  .blog-explore__card-icon {
    width: 48px;
    height: 48px;
    background: var(--color-accent);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .blog-explore__indicator {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--color-primary);
  }

  .blog-explore__card:hover .blog-explore__card-icon {
    background: var(--color-primary);
  }

  .blog-explore__card:hover .blog-explore__indicator {
    background: white;
  }

  .blog-explore__card-content {
    flex: 1;
  }

  .blog-explore__card-title {
    margin: 0 0 0.25rem 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-secondary);
  }

  .blog-explore__card:hover .blog-explore__card-title {
    color: var(--color-primary);
  }

  .blog-explore__card-count {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--color-text-light);
  }

  .blog-explore__arrow {
    font-size: 1.25rem;
    color: var(--color-border);
    transition: all 0.2s;
  }

  .blog-explore__card:hover .blog-explore__arrow {
    color: var(--color-primary);
    transform: translateX(4px);
  }

  @media (min-width: 768px) {
    .catalog-header {
      flex-direction: row;
      justify-content: space-between;
      align-items: flex-end;
    }

    .catalog-header__title {
      font-size: 1.75rem;
    }

    .blog-featured__grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .blog-explore__grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .catalog-header__title {
      font-size: 2rem;
    }

    .blog-featured__grid {
      grid-template-columns: repeat(3, 1fr);
    }

    .blog-explore__grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>
