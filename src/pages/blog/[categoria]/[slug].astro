---
// =============================================================================
// Blog Post - Página de artículo /blog/[categoria]/[slug]
// Diseño profesional con layout de 2 columnas
// =============================================================================

import Layout from '../../../layouts/Base.astro';
import { getCollection, render } from 'astro:content';
import BlogSidebar from '../../../components/blog/BlogSidebar.astro';
import BlogAuthor from '../../../components/blog/BlogAuthor.astro';
import BlogRelatedPosts from '../../../components/blog/BlogRelatedPosts.astro';
import BlogCTA from '../../../components/blog/BlogCTA.astro';
import CotizacionForm from '../../../components/CotizacionForm.astro';
import { buildArticleSchema, buildBreadcrumbSchema } from '../../../lib/seo';
import {
  formatDateSpanish,
  calculateReadingTime,
  getRelatedPosts,
  getAllTags,
  extractTableOfContents,
  CATEGORY_LABELS,
  CATEGORY_SLUGS,
} from '../../../lib/blogHelpers';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);

  return posts.map((post) => {
    const categorySlug = CATEGORY_SLUGS[post.data.categoria] || post.data.categoria;
    return {
      params: {
        categoria: categorySlug,
        slug: post.id,
      },
      props: { post, categorySlug },
    };
  });
}

const { post, categorySlug } = Astro.props;
const { Content, headings } = await render(post);

// Obtener posts relacionados
const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const relatedPosts = getRelatedPosts(post, allPosts, 3);

// Tags para sidebar
const allTags = getAllTags(allPosts);

// TOC items
const tocItems = extractTableOfContents(headings);

// Calcular tiempo de lectura si no está definido
const readingTime = post.data.tiempoLectura || calculateReadingTime(post.body || '');

// Nombre de categoría
const categoryLabel = CATEGORY_LABELS[post.data.categoria] || post.data.categoria;

// Schema Article
const articleSchema = buildArticleSchema({
  title: post.data.title,
  description: post.data.description,
  url: `/blog/${categorySlug}/${post.id}`,
  image: post.data.imagen,
  datePublished: post.data.fecha,
  dateModified: post.data.fechaActualizacion,
  author: post.data.autor,
  category: categoryLabel,
  tags: post.data.tags,
  readingTime,
});

// Schema Breadcrumb
const breadcrumbSchema = buildBreadcrumbSchema([
  { name: 'Inicio', url: '/' },
  { name: 'Blog', url: '/blog' },
  { name: categoryLabel, url: `/blog/${categorySlug}` },
  { name: post.data.title, url: `/blog/${categorySlug}/${post.id}` },
]);
---

<Layout
  title={`${post.data.title} | Blog Gama de México`}
  description={post.data.description}
  ogImage={post.data.imagenOg || post.data.imagen}
  canonical={post.data.canonical}
  heroTitle={post.data.title}
  heroIntro={post.data.description}
  heroBadge={categoryLabel}
  heroPrimaryText="Cotizar Equipos"
  heroPrimaryLink="#cotizar"
  heroSecondaryText="Volver al Blog"
  heroSecondaryLink="/blog"
  structuredData={[articleSchema, breadcrumbSchema]}
>
  <article class="blog-article">
    <div class="container">
      <div class="blog-article__layout">
        <!-- Contenido principal -->
        <div class="blog-article__main">
          <!-- Meta información con badge de categoría -->
          <div class="blog-article__header">
            <a href={`/blog/${categorySlug}`} class="blog-article__category-link">
              <span class="blog-article__category-indicator"></span>
              {categoryLabel}
            </a>
            <div class="blog-article__meta">
              <time datetime={post.data.fecha}>{formatDateSpanish(post.data.fecha)}</time>
              <span class="blog-article__separator">·</span>
              <span>{readingTime} min lectura</span>
              {post.data.fechaActualizacion && (
                <>
                  <span class="blog-article__separator">·</span>
                  <span class="blog-article__updated">Actualizado: {formatDateSpanish(post.data.fechaActualizacion)}</span>
                </>
              )}
            </div>
          </div>

          <!-- Imagen destacada -->
          {post.data.imagen && (
            <figure class="blog-article__hero-image">
              <img
                src={post.data.imagen}
                alt={post.data.imagenAlt || post.data.title}
                loading="eager"
              />
              {post.data.imagenAlt && (
                <figcaption class="blog-article__image-caption">{post.data.imagenAlt}</figcaption>
              )}
            </figure>
          )}

          <!-- Contenido markdown -->
          <div class="blog-article__content">
            <Content />
          </div>

          <!-- CTA inline -->
          <BlogCTA variant="fullwidth" />

          <!-- Tags -->
          {post.data.tags && post.data.tags.length > 0 && (
            <div class="blog-article__tags">
              <span class="blog-article__tags-label">Etiquetas:</span>
              <div class="blog-article__tags-list">
                {post.data.tags.map((tag) => (
                  <a href={`/blog/tag/${encodeURIComponent(tag)}`} class="blog-article__tag">
                    {tag}
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Caja del autor -->
          <BlogAuthor autor={post.data.autor} />
        </div>

        <!-- Sidebar -->
        <BlogSidebar headings={tocItems} tags={allTags} showCTA={true} categorySlug={categorySlug} />
      </div>
    </div>
  </article>

  <!-- Artículos relacionados -->
  <BlogRelatedPosts
    posts={relatedPosts}
    titulo="Artículos Relacionados"
    subtitulo="Continúa aprendiendo sobre equipos contra incendios"
  />

  <!-- Formulario de cotización -->
  <section id="cotizar" class="blog-cotizar">
    <div class="container">
      <CotizacionForm
        titulo="¿Necesitas Asesoría Técnica?"
        pagina={`Blog: ${post.data.title}`}
      />
    </div>
  </section>
</Layout>

<style>
  .blog-article {
    padding: var(--spacing-3xl) 0;
    background: var(--color-white);
  }

  .blog-article__layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--spacing-2xl);
  }

  .blog-article__main {
    max-width: 100%;
    min-width: 0;
  }

  /* HEADER */
  .blog-article__header {
    margin-bottom: var(--spacing-xl);
    padding-bottom: var(--spacing-lg);
    border-bottom: 2px solid var(--color-primary);
  }

  .blog-article__category-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--color-accent);
    border-radius: 6px;
    text-decoration: none;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-secondary);
    margin-bottom: var(--spacing-sm);
    transition: all 0.2s;
  }

  .blog-article__category-link:hover {
    background: var(--color-primary);
    color: white;
  }

  .blog-article__category-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-primary);
  }

  .blog-article__category-link:hover .blog-article__category-indicator {
    background: white;
  }

  .blog-article__meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--font-size-sm);
    color: var(--color-text-light);
  }

  .blog-article__separator {
    color: var(--color-border);
  }

  .blog-article__updated {
    color: var(--color-primary);
    font-weight: 500;
  }

  /* HERO IMAGE */
  .blog-article__hero-image {
    margin: 0 0 var(--spacing-xl) 0;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
  }

  .blog-article__hero-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  .blog-article__image-caption {
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-accent);
    font-size: var(--font-size-xs);
    color: var(--color-text-light);
    text-align: center;
  }

  /* CONTENIDO MARKDOWN */
  .blog-article__content {
    max-width: 100%;
  }

  .blog-article__content :global(h2) {
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-secondary);
    line-height: 1.3;
    padding-bottom: var(--spacing-sm);
    border-bottom: 1px solid var(--color-border);
  }

  .blog-article__content :global(h3) {
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-sm);
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-secondary);
    line-height: 1.35;
  }

  .blog-article__content :global(h4) {
    margin-top: var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-secondary);
  }

  .blog-article__content :global(p) {
    margin-bottom: var(--spacing-md);
    font-size: var(--font-size-base);
    line-height: 1.8;
    color: var(--color-text);
  }

  .blog-article__content :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
    font-weight: 500;
  }

  .blog-article__content :global(a:hover) {
    color: var(--color-primary-dark);
  }

  .blog-article__content :global(ul),
  .blog-article__content :global(ol) {
    margin-bottom: var(--spacing-md);
    padding-left: var(--spacing-lg);
  }

  .blog-article__content :global(li) {
    margin-bottom: var(--spacing-xs);
    line-height: 1.7;
    color: var(--color-text);
  }

  .blog-article__content :global(li::marker) {
    color: var(--color-primary);
  }

  .blog-article__content :global(strong) {
    font-weight: 600;
    color: var(--color-secondary);
  }

  .blog-article__content :global(blockquote) {
    margin: var(--spacing-xl) 0;
    padding: var(--spacing-lg);
    border-left: 4px solid var(--color-primary);
    background: var(--color-accent);
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
  }

  .blog-article__content :global(blockquote p) {
    margin-bottom: 0;
    font-style: italic;
    color: var(--color-text);
  }

  .blog-article__content :global(code) {
    background: var(--color-accent);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: 'Consolas', 'Monaco', monospace;
    color: var(--color-primary);
  }

  .blog-article__content :global(pre) {
    background: var(--color-secondary);
    color: var(--color-white);
    padding: var(--spacing-md);
    border-radius: var(--border-radius);
    overflow-x: auto;
    margin: var(--spacing-lg) 0;
  }

  .blog-article__content :global(pre code) {
    background: none;
    padding: 0;
    color: inherit;
  }

  .blog-article__content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--border-radius);
    margin: var(--spacing-lg) 0;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  }

  .blog-article__content :global(hr) {
    border: none;
    height: 2px;
    background: linear-gradient(90deg, var(--color-primary), transparent);
    margin: var(--spacing-2xl) 0;
  }

  /* TABLAS PROFESIONALES */
  .blog-article__content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: var(--spacing-lg) 0;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  }

  .blog-article__content :global(th),
  .blog-article__content :global(td) {
    padding: 0.875rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .blog-article__content :global(th) {
    background: var(--color-secondary);
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .blog-article__content :global(tr:nth-child(even)) {
    background: var(--color-accent);
  }

  .blog-article__content :global(tr:hover) {
    background: rgba(196, 30, 58, 0.05);
  }

  /* TAGS */
  .blog-article__tags {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem;
    margin-top: var(--spacing-xl);
    padding: var(--spacing-lg);
    background: var(--color-accent);
    border-radius: var(--border-radius);
  }

  .blog-article__tags-label {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-secondary);
  }

  .blog-article__tags-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .blog-article__tag {
    display: inline-block;
    padding: 0.375rem 0.875rem;
    border-radius: 50px;
    font-size: var(--font-size-xs);
    font-weight: 500;
    color: var(--color-text);
    background: var(--color-white);
    border: 1px solid var(--color-border);
    text-decoration: none;
    transition: all 0.2s;
  }

  .blog-article__tag:hover {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
  }

  /* COTIZACIÓN */
  .blog-cotizar {
    padding: var(--spacing-3xl) 0;
    background: var(--color-accent);
  }

  @media (min-width: 768px) {
    .blog-article__content :global(h2) {
      font-size: 1.75rem;
    }
  }

  @media (min-width: 1024px) {
    .blog-article__layout {
      grid-template-columns: 1fr 320px;
      gap: 2.5rem;
    }

    .blog-article__content :global(h2) {
      font-size: 2rem;
    }
  }

  @media (min-width: 1280px) {
    .blog-article__layout {
      grid-template-columns: 1fr 340px;
    }
  }
</style>
